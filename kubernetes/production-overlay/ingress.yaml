# ============================================================================
# Akamai Cloud Wazuh Quick-Start - Ingress Configuration
# ============================================================================
# This Ingress resource provides HTTPS access to the Wazuh Dashboard:
#   - Hostname: wazuh.${DOMAIN}
#   - TLS: Let's Encrypt certificate (auto-provisioned)
#   - Backend: wazuh-dashboard service on port 5601
#   - ExternalDNS: Automatic A record creation
#
# Access: https://wazuh.${DOMAIN}
# ============================================================================

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: wazuh-dashboard-ingress
  namespace: wazuh
  labels:
    app: wazuh-dashboard
    component: ingress
  annotations:
    # Ingress class
    kubernetes.io/ingress.class: nginx

    # ExternalDNS - Automatic DNS record creation
    external-dns.alpha.kubernetes.io/hostname: "wazuh.${DOMAIN}"
    external-dns.alpha.kubernetes.io/ttl: "300"

    # cert-manager - Automatic TLS certificate provisioning
    cert-manager.io/cluster-issuer: letsencrypt-prod

    # NGINX Ingress settings
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"

    # Increase proxy timeouts for large dashboard operations
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"

    # Proxy buffer size for Wazuh dashboard
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"

    # Body size limit for file uploads
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"

    # Security headers
    nginx.ingress.kubernetes.io/enable-cors: "false"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";

    # Rate limiting (optional, uncomment to enable)
    # nginx.ingress.kubernetes.io/limit-rps: "10"

    # Documentation
    description: "Wazuh Dashboard HTTPS ingress with Let's Encrypt TLS"

spec:
  # TLS configuration
  tls:
    - hosts:
        - wazuh.${DOMAIN}
      secretName: wazuh-dashboard-tls

  # Routing rules
  rules:
    - host: wazuh.${DOMAIN}
      http:
        paths:
          # Main dashboard path
          - path: /
            pathType: Prefix
            backend:
              service:
                name: wazuh-dashboard
                port:
                  number: 5601

---
# Certificate resource for cert-manager
# This is automatically created by the ingress annotation,
# but defining it explicitly provides better control
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wazuh-dashboard-cert
  namespace: wazuh
  labels:
    app: wazuh-dashboard
    component: certificate
spec:
  # Secret name to store the certificate
  secretName: wazuh-dashboard-tls

  # Certificate duration (Let's Encrypt default: 90 days)
  duration: 2160h  # 90 days
  renewBefore: 360h  # 15 days before expiration

  # Subject configuration
  subject:
    organizations:
      - Wazuh SIEM

  # Common name and DNS names
  commonName: wazuh.${DOMAIN}
  dnsNames:
    - wazuh.${DOMAIN}

  # Issuer reference
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
    group: cert-manager.io

  # Private key configuration
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 4096
    rotationPolicy: Always

  # Use HTTP-01 challenge
  usages:
    - digital signature
    - key encipherment
    - server auth
